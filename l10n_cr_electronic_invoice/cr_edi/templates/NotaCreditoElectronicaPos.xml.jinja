<NotaCreditoElectronica
    xmlns="https://cdn.comprobanteselectronicos.go.cr/xml-schemas/v4.3/notaCreditoElectronica"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="https://www.hacienda.go.cr/ATV/ComprobanteElectronico/docs/esquemas/2016/v4.3/NotaCreditoElectronica_V4.3.xsd">
    <Clave>{{document.number_electronic}}</Clave>
    <CodigoActividad>{{activity_code}}</CodigoActividad>
    <NumeroConsecutivo>{{document.number_electronic[21:41]}}</NumeroConsecutivo>
    <FechaEmision>{{document.date_issuance}}</FechaEmision>
    <Emisor>
        <Nombre>{{issuer.name}}</Nombre>
        <Identificacion>
            <Tipo>{{issuer.identification_id.code}}</Tipo>
            <Numero>{{issuer.vat}}</Numero>
        </Identificacion>
        <NombreComercial>{{issuer.commercial_name or "NA"}}</NombreComercial>
        <Ubicacion>
            <Provincia>{{issuer.state_id.code}}</Provincia>
            <Canton>{{issuer.county_id.code}}</Canton>
            <Distrito>{{issuer.district_id.code}}</Distrito>
            <Barrio>{{issuer.neighborhood_id.code}}</Barrio>
            <OtrasSenas>{{issuer.street or "NA"}}</OtrasSenas>
        </Ubicacion>
        <Telefono>
            <CodigoPais>{{phone_obj_issuer.country_code}}</CodigoPais>
            <NumTelefono>{{phone_obj_issuer.national_number}}</NumTelefono>
        </Telefono>
        <CorreoElectronico>{{issuer.email}}</CorreoElectronico>
    </Emisor>
    <Receptor>
        <Nombre>{{receiver and receiver.name[:99] or "No especificado"}}</Nombre>
    </Receptor>
    <CondicionVenta>{{reference.payment_ids.payment_method_id.account_payment_term_id.sale_conditions_id.sequence}}</CondicionVenta>
    <PlazoCredito>{{ 0 }}</PlazoCredito>
    <MedioPago>{{reference.payment_ids.payment_method_id.payment_method_id.sequence}}</MedioPago>
    <DetalleServicio>
        {% for line in lines %}
        <LineaDetalle>
            <NumeroLinea>{{line['numero_linea']}}</NumeroLinea>
            <Codigo>{{line['codigo']}}</Codigo>
            <Cantidad>{{line['cantidad']}}</Cantidad>
            <UnidadMedida>{{line['unidad_medida']}}</UnidadMedida>
            <Detalle>{{line['detalle']}}</Detalle>
            <PrecioUnitario>{{line['precio_unitario']}}</PrecioUnitario>
            <MontoTotal>{{line['monto_total']}}</MontoTotal>
            {% if line['discount'] %}
            <Descuento>
                <MontoDescuento>{{line['monto_descuento']}}</MontoDescuento>
                <NaturalezaDescuento>{{line['naturaleza_descuento']}}</NaturalezaDescuento>
            </Descuento>
            {% endif %}
            <SubTotal>{{line['sub_total']}}</SubTotal>
            {% for tax in line['impuestos'] %}
            <Impuesto>
                <Codigo>{{tax['codigo']}}</Codigo>
                <CodigoTarifa>{{tax['codigo_tarifa']}}</CodigoTarifa>
                <Tarifa>{{tax['tarifa']}}</Tarifa>
                <Monto>{{tax['monto']}}</Monto>
            </Impuesto>
            {% endfor %}
            <ImpuestoNeto>{{line['impuesto_neto']}}</ImpuestoNeto>
            <MontoTotalLinea>{{line['monto_total_linea']}}</MontoTotalLinea>
        </LineaDetalle>
        {% endfor %}
    </DetalleServicio>
    {# <OtrosCargos>
        {% for other_charge in lines.other_charges %}
        <TipoDocumento>{{otrosCargos[otro_cargo]["TipoDocumento"]}}</TipoDocumento>
        <NumeroIdentidadTercero>{{otrosCargos[otro_cargo]["NumeroIdentidadTercero"]}}</NumeroIdentidadTercero>
        <NombreTercero>{{otrosCargos[otro_cargo]["NombreTercero"]}}</NombreTercero>
        <Detalle>{{otrosCargos[otro_cargo]["Detalle"]}}</Detalle>
        <Porcentaje>{{otrosCargos[otro_cargo]["Porcentaje"]}}</Porcentaje>
        <MontoCargo>{{otrosCargos[otro_cargo]["MontoCargo"]}}</MontoCargo>
        {% endfor %}
    </OtrosCargos> #}
    <ResumenFactura>
        <CodigoTipoMoneda>
            <CodigoMoneda>{{document.currency_id.name}}</CodigoMoneda>
            <TipoCambio>{{(currency_rate)|round(5)}}</TipoCambio>
        </CodigoTipoMoneda>
        <TotalServGravados>{{"%.4f"|format(amounts["service_taxed"])}}</TotalServGravados>
        <TotalServExentos>{{"%.4f"|format(amounts["service_no_taxed"])}}</TotalServExentos>
        <TotalServExonerado>{{"%.4f"|format(amounts["service_exempt"])}}</TotalServExonerado>
        <TotalMercanciasGravadas>{{"%.4f"|format(amounts["product_taxed"])}}</TotalMercanciasGravadas>
        <TotalMercanciasExentas>{{"%.4f"|format(amounts["product_no_taxed"])}}</TotalMercanciasExentas>
        <TotalMercExonerada>{{"%.4f"|format(amounts["product_exempt"])}}</TotalMercExonerada>
        <TotalGravado>{{"%.4f"|format(amounts["total_gravado"])}}</TotalGravado>
        <TotalExento>{{"%.4f"|format(amounts["total_exento"])}}</TotalExento>
        <TotalExonerado>{{"%.4f"|format(amounts["monto_exonerado"])}}</TotalExonerado>
        <TotalVenta>{{"%.4f"|format(amounts['total_venta'])}}</TotalVenta>
        <TotalDescuentos>{{"%.4f"|format(amounts["discount"])}}</TotalDescuentos>
        <TotalVentaNeta>{{"%.4f"|format(amounts['venta_neta'])}}</TotalVentaNeta>
        <TotalImpuesto>{{"%.4f"|format(amounts['total_impuesto'])}}</TotalImpuesto>
        <TotalOtrosCargos>{{"%.4f"|format(amounts["other_charges"])}}</TotalOtrosCargos>
        <TotalComprobante>{{"%.4f"|format(amounts['total_comprobante'])}}</TotalComprobante>
    </ResumenFactura>
    <InformacionReferencia>
        <TipoDoc>{{reference.number_electronic[29:31]}}</TipoDoc>
        <Numero>{{reference.number_electronic}}</Numero>
        <FechaEmision>{{reference.date_issuance}}</FechaEmision>
        <Codigo>{{reference_code.code}}</Codigo>
        <Razon>{{reference_code.name}}</Razon>
    </InformacionReferencia>
    <Otros>
        <OtroTexto>{{notes}}</OtroTexto>
    </Otros>
</NotaCreditoElectronica>
